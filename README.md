# これは何？
ML-LabelMateと言います。
プロジェクト非公式のキャプションファイル作成支援スクリプトです。

現在google colab版のみ提供しています。

キャプションtextの作成補助用csvファイルの生成、csvからキャプションファイルの生成、画像の自動リサイズ機能などを提供しています。

csvファイルはエクセルに代表される表計算ソフトで読み込めるファイル形式です。テキストファイルを一つずつ編集するより一覧性が高く、表計算ソフト独自の便利な機能を使うことでキャプション付けの速度向上が見込めます。

同一ではないが類似したキャプションを持つ大量の画像に対して特に効果的です。

下のcolabボタンを押すとノートブックが開きます。

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/nagaokayama/captioning_scripts/blob/main/Text_cordinator.ipynb)



# csv生成からデータ投稿までの流れ
基本的には作業に応じて上のセルから順番に実行していくことになります。

Googleドライブに画像ファイルをアップロード

指定フォルダ内の画像ファイルを元にcsvを生成

外部ソフトを使用(csvファイルでキャプションを編集）

編集したcsvをgoogle driveにアップロード

アップしたcsvをもとにしてキャプションが記入されたテキストファイルを生成

テキストファイルをダウンロード(zip利用可)

※画像とテキストファイルをまとめてzipに圧縮した場合、そのファイルはそのままdiscordのコマンドで投稿できます

___

# How to Use

- このプログラムの使用にあたってはgoogleアカウントが必要です

google drive、google colabの基本的な操作方法は各自調べてください。このスクリプトを使うにあたってgoogle colabへの課金は必要ありません。

基本的には使いたいセルの入力フォームを上から埋めて「セルを実行」を押せばOK

**画像ファイルの変更を伴うセルの実行はバックアップをとり注意して行ってください。バグはなるべく早期に取り除きますが画像ファイルに意図しない変更が加えられる可能性があります**

## 事前準備

あらかじめ Google driveに画像ファイルをフォルダにまとめてアップロードしておくと作業がスムーズになります。（zipファイル可）

google drive内のファイルを利用する場合は一番上のセル「0. ⛰google driveのファイルを使用する場合はまずこのスクリプトを実行してください」を実行してください。

google drive使用の有無に関係なく**最初に一回だけ**「0.🎍最初に一度だけ実行してください」を実行してください。

必要なモジュールのインストールや関数のセットアップが行われます。

## 🎊ZIPファイルを展開
ZIPファイルを指定したフォルダに展開（解凍）します。googledriveを介さずgoogle colabのディスク領域に直接ファイルを置きたいときなどに活用してください。

## 📖キャプション編集用csvテンプレートを生成

画像が入ったフォルダと、すべての画像に共通するキャプションを記入すると左端の縦列に画像名、各横列にキャプションを割り当てたcsvファイルを作ります。生成したcsvは各種表計算アプリで読み込めます。

エクスポート時にexport_with_shiftjisのチェックをつけることでmicrosoftエクセルで開いても文字化けしなくなります。
![image](https://github.com/nagaokayama/captioning_scripts/assets/152504610/79e9251f-ba77-4f28-a103-da3d71b19dbf)

## 📰フォルダ内のテキストファイルからCSVを作成
指定したフォルダに存在するテキストファイル（複数可）のファイル名と内容を一つの決まった形式のcsvファイル(後述)にまとめて保存します。

## ✒csvからキャプションファイルを生成
決まった形式のcsvファイル(後述)を読み込んで画像ごとのキャプションtxtに分割してくれます。生成されたtxtファイルをダウンロードして使ってください。

前述のセルで生成したcsvに限らず、形式が揃ってさえいればどのようなcsvでも読み込むことができます
![image](https://github.com/nagaokayama/captioning_scripts/assets/152504610/b6b0a242-9711-4158-a692-f74ec835f001)


### 決まった形式のcsvファイルとは...
一番左の縦列に拡張子を除いた画像ファイル名、その横にキャプションが各セルにダーッと並んでる形式です。ヘッダーはありません。

「キャプションcsv生成」で生成されるcsvはこの形式に沿ったものが作られます。

![image](https://github.com/nagaokayama/captioning_scripts/assets/152504610/65bbc0a9-9909-4257-9deb-0a8af0ec31c4)


## 🎨学習向けに画像サイズを変更（自己責任でお願いします）
mitsua likesにアップロードする画像の最低サイズとモデルの学習に十分な解像度の両方を満たすように画像をリサイズします。

具体的には短辺512px以上、画素数が2の20乗px（処理上は110万pxを目安にしています）を両方満たすように拡大もしくは縮小して指定したフォルダへ新しい画像として保存します。

一応元の画像を上書きしないように簡単なセーフティーはつけていますが確実な物ではありません。画像のバックアップを取ってからご利用ください。

このリサイズ処理を通すことでファイルサイズが小さくなるので最大枚数の100枚でzipにまとめてもファイルサイズがたいていの場合discordのアップロード上限サイズ内に収まる利点もあります。

## 👾画像を100枚ずつフォルダに分配する（自己責任でお願いします）
フォルダ内の画像をupload_zipの現行ルールに沿って100枚ずつ別フォルダへ分配します。

分配先に指定したフォルダの下位にサブフォルダ（sub_1, sub_2...）が作成され、ここに100枚ずつ画像がコピーされます。

画像と同名のテキストファイル（キャプションファイル）がある場合はこれも同時に分配されます。

ちょっと自己責任ですがオプションをONにすることで分配と同時にzipファイルを作成したり画像とテキストのコピーを残さないこともできます。
![image](https://github.com/nagaokayama/captioning_scripts/assets/152504610/f6f34565-f04f-4bb3-beb2-cf9347b6a75e)


## 📦ZIPファイルを作成
指定したフォルダの中身をzipに圧縮もしくは指定したzipファイルを展開します

複数フォルダを一度に圧縮したいときはフォルダパスを,か、で区切って記入してください

----

下のcolabボタンを押すとスクリプトが開きます。

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/nagaokayama/captioning_scripts/blob/main/Text_cordinator.ipynb)


# よくある質問

　- name error: name "xxx" is not defined と出る

「0.🎍最初に一度だけ実行してください」を実行してからもう一度エラーの出たセルを実行してください


　- 特定の用途に特化したCSVファイルを作成して配布しても良い？

特に許可なく作成配布して構いません。機能追加の要望があればお知らせください



 
# 修正履歴（大きなもの）
2025/3/16　『📰フォルダ内のテキストファイルからCSVを作成』セルを追加

2024/02/12  hiec画像の読み込みに対応、リサイズ時のexifによる画像の回転を抑制

2024/1　　 ZIPの展開・圧縮を行えるセルを追加しました

2023/12/26　画像とテキストを100ずつに分割する機能を実装

2023/12/16　画像リサイズとCSVをshiftJISで生成モードを実装

2023/12/12　モジュールインポートを分離した関係でセルレイアウトとスクリプトの実行手順がやや変化

2023/12/10  画像ファイルからCSVファイル生成セルについて、拡張子に大文字を含む画像ファイルの名前がcsvファイルにリストアップされない問題を修正

2023/12/05　空の文字列タグをキャプションテキストに書き込まないように修正
